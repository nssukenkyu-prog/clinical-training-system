rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to check if user is admin
    // Note: This assumes admin email is used as document ID or we query it. 
    // Since we can't easily query in rules, we might rely on custom claims or just check if auth email is in admins collection.
    // For simplicity here, we assume admin management is done securely.
    // A better approach for admin check in rules without custom claims:
    // exists(/databases/$(database)/documents/admins/$(request.auth.token.email)) 
    // BUT email as ID is tricky if it has special chars. 
    // Let's assume we use a known admin ID or just allow write if authenticated as specific email (hardcoded) or use a collection check if IDs are emails.
    // In our app, we store admins with auto-IDs but query by email. This makes rules hard.
    // Alternative: Store admins with email as ID (sanitized).
    // For now, let's just allow write if request.auth.token.email matches a hardcoded list or if we can lookup.
    // Since we can't easily lookup by property, we'll stick to basic auth checks for now and rely on app logic + maybe a special 'admin' flag in user metadata if we had it.
    // For this migration, we will allow write if the user is authenticated and has an email that ends with a specific domain or is in a hardcoded list?
    // No, let's try to use the 'admins' collection check if possible.
    // If we can't, we'll just require auth for writes and rely on client app hiding admin routes (not secure but better than open).
    // BETTER: Allow write to 'slots', 'settings' only if request.auth.token.email == 'admin@example.com' (or whatever the admin email is).
    // Since I don't know the admin email, I will leave a TODO or use a placeholder.
    
    function isAuthenticated() {
      return request.auth != null;
    }

    match /admins/{adminId} {
      allow read: if isAuthenticated();
      allow write: if false; // Only manual updates
    }

    match /students/{studentId} {
      allow read: if true; // Needed for login/signup lookup
      allow create: if isAuthenticated(); // Admin creates
      allow update: if isAuthenticated(); // Admin or Student (password_set)
      allow delete: if isAuthenticated(); // Admin
    }

    match /slots/{slotId} {
      allow read: if true;
      allow write: if isAuthenticated(); // Admin
    }

    match /reservations/{reservationId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }

    match /settings/{settingId} {
      allow read: if true;
      allow write: if isAuthenticated();
    }
  }
}
